<!DOCTYPE html><html lang="en"><head><title>lib/mqtt-reqres</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="lib/mqtt-reqres"><meta name="groc-project-path" content="lib/mqtt-reqres.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">lib/mqtt-reqres.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h2 id="mqttreqres">MqttReqRes</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A connect(B)</p>
<ul>
<li><p>when connreq &amp;&amp; connack === connreq</p>
<ul>
<li>resolve</li>
</ul>
</li>
<li><p>else when !connreq || connack !== connreq</p>
<ul>
<li>set connreq = randomString</li>
<li>set connack = null</li>
<li>set channelNonce = randomString()</li>
<li>send connreq,channelNonce to B.handleConnectRequest()</li>
<li>wait for connackResolve</li>
<li>resolve / reject on timeout</li>
</ul>
</li>
</ul>
<p>B handleConnectRequest (connreqA, channelNonceA)</p>
<ul>
<li><p>when !connreqA</p>
<ul>
<li>ignore, done</li>
</ul>
</li>
<li><p>else when !connreq || connreqA !== connack</p>
<ul>
<li>set connreq = connreqA</li>
<li>set connack = connreqA</li>
<li>set channelNonce = randomString()</li>
<li>set channelSendId = hash(connack, channelNonce, channelNonceA, sharedSecretAB)</li>
<li>set channelReceiveId = hash(connack, channelNonceA, channelNonce, sharedSecretAB)</li>
<li>subscribe topic to receive from A</li>
<li>send connack,channelNonce to A.handleConnectAck()</li>
<li>done</li>
</ul>
</li>
<li><p>else when connreqA === connack</p>
<ul>
<li>send connack,channelNonce to A.handleConnectAck()</li>
<li>done</li>
</ul>
</li>
<li><p>else    </p>
<ul>
<li>ignore, done</li>
</ul>
</li>
</ul>
<p>A handleConnectAck (connackB, channelNonceB)</p>
<p>  when connreq &amp;&amp; connreq === connackB</p>
<pre><code>- set connack = connreq
- set channelSendId = hash(connack, channelNonce, channelNonceB, sharedSecretAB)
- set channelReceiveId = hash(connack, channelNonceB, channelNonce, sharedSecretAB)
- subscribe topic to receive from B
- connackResolve()</code></pre>
<ul>
<li>else<ul>
<li>ignore</li>
</ul>
</li>
</ul>
<p>B connect(A): vice versa</p>
<p>mqtt messages types by topicPath[3]</p>
<p>  message topic publish -t message/<from-device-id>/<to-channel-id>/<mqtt-message-type></p>
<ul>
<li>request: message-id</li>
<li>response: message-id responds-to</li>
<li>stream: message-id, stream-id, message-target-property</li>
<li>stream-end: message-id, stream-id</li>
<li>request-end: message-id</li>
<li>response-end: message-id</li>
<li><p>chunk: stream-id chunk-id</p>
</li>
<li><p>chunk-ack: to-id</p>
</li>
<li>stream-end-ack: to-id </li>
<li>request-end-ack: to-id</li>
<li><p>response-end-ack: to-id</p>
</li>
<li><p>stream-ack: to-id </p>
</li>
<li>request-ack: to-id</li>
<li>response-ack: to-id</li>
</ul>
<p>message flow:</p>
<p>  A: request
  B: request-ack
      A: stream
      B: stream-ack
        A: chunk 
          B: chunk-ack
        .. A: chunk
      A: stream-end
      B: stream-end-ack
      ..A: stream
      A: request-end
      B: request-end-ack
      B: response
      A: response-ack
        B: stream
        A: stream-ack
          B: chunk
            A: chunk-ack
          .. B: chunk
        B: stream-end
        A: stream-end-ack
        .. B: stream
        B: response-end
        A: response-end-ack</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="export-module">export module</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
<span class="hljs-pi">
  'use strict'</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="dependencies">dependencies</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> mqtt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mqtt'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>var EventEmitter = require(&#39;events&#39;);</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'eventemitter2'</span>);
  <span class="hljs-keyword">var</span> CryptoJS = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./crypto-js/cryptojs-module.js'</span>);
  <span class="hljs-keyword">var</span> debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'mqtt-reqres'</span>);
  <span class="hljs-keyword">var</span> noop = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{};

  <span class="hljs-keyword">var</span> MAX_CHUNK_SIZE = <span class="hljs-number">1024</span> * <span class="hljs-number">64</span>;
  <span class="hljs-keyword">var</span> MAX_HASH_LENGTH = <span class="hljs-number">81</span>;  <span class="hljs-comment">// 81</span>

  <span class="hljs-keyword">var</span> CLIENT_ID_LENGTH = <span class="hljs-number">23</span>; <span class="hljs-comment">// 23</span>
  <span class="hljs-keyword">var</span> CHANNEL_ID_LENGTH = <span class="hljs-number">25</span>; <span class="hljs-comment">// 25</span>
  <span class="hljs-keyword">var</span> CHANNEL_NONCE_LENGTH = <span class="hljs-number">25</span>; <span class="hljs-comment">// 25</span>
  <span class="hljs-keyword">var</span> MESSAGE_ID_LENGTH = <span class="hljs-number">20</span>; <span class="hljs-comment">// 20</span>
  <span class="hljs-keyword">var</span> STREAM_ID_LENGTH = <span class="hljs-number">10</span>; <span class="hljs-comment">// 10</span>
  <span class="hljs-keyword">var</span> CHUNK_ID_LENGTH = <span class="hljs-number">10</span>; <span class="hljs-comment">// 10</span>

  <span class="hljs-keyword">var</span> messageTypes = [
    <span class="hljs-string">'request'</span>,        
    <span class="hljs-string">'request-ack'</span>,        
    <span class="hljs-string">'request-end'</span>,     
    <span class="hljs-string">'request-end-ack'</span>,     
    <span class="hljs-string">'ping'</span>,
    <span class="hljs-string">'ping-ack'</span>,
    <span class="hljs-string">'response'</span>,        
    <span class="hljs-string">'response-ack'</span>,   
    <span class="hljs-string">'response-end'</span>,    
    <span class="hljs-string">'response-end-ack'</span>,    
    <span class="hljs-string">'stream'</span>,          
    <span class="hljs-string">'stream-ack'</span>,        
    <span class="hljs-string">'stream-end'</span>,      
    <span class="hljs-string">'stream-end-ack'</span>,      
    <span class="hljs-string">'chunk'</span>,         
    <span class="hljs-string">'chunk-ack'</span>
  ];</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="class-mqttreqres">class MqttReqRes</h3>
<h4 id="constructoroptions">constructor(options)</h4>
<p>  options:</p>
<ul>
<li>brokerProtocol string optional default &#39;mqtt&#39; (&#39;ws&#39;)</li>
<li>brokerHostname string optional default &#39;localhost&#39;</li>
<li>brokerPort number optional default 1883</li>
<li>clientId string optional default random string</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">MqttReqRes</span> (<span class="hljs-params">options</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>call super constructor.</p></div></div><div class="code"><div class="wrapper">    EventEmitter.call(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">this</span>.options = options = options || {};

    <span class="hljs-keyword">this</span>.initialize(options);
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>MqttReqRes extends EventEmitter</p></div></div><div class="code"><div class="wrapper">  MqttReqRes.prototype = <span class="hljs-built_in">Object</span>.create(EventEmitter.prototype);
  MqttReqRes.prototype.constructor = MqttReqRes;  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>expose EventEmitter</p></div></div><div class="code"><div class="wrapper">  MqttReqRes.EventEmitter = EventEmitter;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqresrandomstringlength">MqttReqRes.randomString(length)</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.randomString = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">length</span>) </span>{
      
    <span class="hljs-keyword">var</span> validChars = <span class="hljs-string">'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>,
      validCharsLength = validChars.length,
      str = <span class="hljs-string">''</span>,
      remaining;

    remaining = length = length || <span class="hljs-number">25</span>;

    <span class="hljs-keyword">while</span> (remaining--) {
      str += validChars[<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * validCharsLength)];
    }

    <span class="hljs-keyword">return</span> str;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqreshash">MqttReqRes.hash()</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.hash = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>use sha512</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> shasum = CryptoJS.algo.SHA512.create(),
      args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">0</span>),
      hash;

    args.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">v</span>) </span>{
      shasum.update(<span class="hljs-built_in">String</span>(v));
    });

    hash = shasum.finalize();

    <span class="hljs-keyword">return</span> hash.toString(CryptoJS.enc.Base64)
      .replace(<span class="hljs-regexp">/\W/g</span>,<span class="hljs-string">''</span>)
      .substr(<span class="hljs-number">0</span>, MAX_HASH_LENGTH);
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqresencryptmessage-secret">MqttReqRes.encrypt(message, secret)</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.encrypt = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">message, secret</span>) </span>{
    <span class="hljs-keyword">var</span> encrypted = CryptoJS.AES.encrypt(<span class="hljs-built_in">String</span>(message), secret);
    <span class="hljs-keyword">return</span> CryptoJS.AESJsonFormatter.stringify(encrypted);
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqresdecryptencrypted-secret">MqttReqRes.decrypt(encrypted, secret)</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.decrypt = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">encrypted, secret</span>) </span>{
    <span class="hljs-keyword">var</span> decrypted = encrypted ? 
      CryptoJS.AES.decrypt(encrypted, secret, {format: CryptoJS.AESJsonFormatter}) : <span class="hljs-string">''</span>;
    <span class="hljs-keyword">return</span> encrypted &amp;&amp; decrypted ? decrypted.toString(CryptoJS.enc.Utf8) : <span class="hljs-string">''</span>;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqressecretconnection">MqttReqRes.secret(connection)</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.secret = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">connection</span>) </span>{
    <span class="hljs-keyword">return</span> MqttReqRes.hash(
        connection.sharedSecret,
        connection.connreq
      );
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqresisconnectedconnection">MqttReqRes.isConnected(connection)</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.isConnected = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">connection</span>) </span>{
    <span class="hljs-keyword">return</span> !!(
      connection &amp;&amp; 
      connection.clientId &amp;&amp;
      connection.sharedSecret &amp;&amp;
      connection.connreq &amp;&amp; 
      connection.connreq === connection.connack &amp;&amp; 
      connection.channelNonce &amp;&amp; 
      connection.channelSendId &amp;&amp; 
      connection.topicSend &amp;&amp; 
      connection.channelReceiveId &amp;&amp; 
      connection.topicReceive
    );
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqresinitializeoptions">MqttReqRes.initialize(options)</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.prototype.initialize = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">options</span>) </span>{

    debug(<span class="hljs-string">'initialize()'</span>, options);

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>remove all internal listeners</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">this</span>.removeAllListeners(<span class="hljs-string">'_broker-connect'</span>);
    <span class="hljs-keyword">this</span>.removeAllListeners(<span class="hljs-string">'_client-connack'</span>);
    <span class="hljs-keyword">this</span>.removeAllListeners(<span class="hljs-string">'_chunk-sent'</span>);

    messageTypes.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">messageType</span>) </span>{
     self.removeAllListeners(<span class="hljs-string">'_mqtt-message-'</span> + messageType);
    });
    
    <span class="hljs-keyword">this</span>.mqttClient = <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">this</span>.brokerProtocol = options.brokerProtocol || <span class="hljs-string">'mqtt'</span>;
    <span class="hljs-keyword">this</span>.brokerHostname = options.brokerHostname || <span class="hljs-string">'localhost'</span>;
    <span class="hljs-keyword">this</span>.brokerPort = options.brokerPort || <span class="hljs-number">1883</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The Server MUST allow ClientIds which are between 1 and 23 UTF-8 encoded bytes in 
length, and that contain only the characters 0-9a-Z</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">this</span>.clientId = options.clientId || MqttReqRes.randomString(CLIENT_ID_LENGTH);

    <span class="hljs-keyword">this</span>.subscribedConnect = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.isWaitingForMqttClientMessages = <span class="hljs-literal">false</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>use <code>client.sharedSecret(function (clientId, cb){cb(&#39;my-secret&#39;);})</code> to set function </p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">this</span>.fnGetSharedSecret = <span class="hljs-literal">null</span>;
    
    <span class="hljs-keyword">this</span>.fnOnRequest = <span class="hljs-literal">null</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>list of connections to other clients</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">this</span>.connections = [];
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqresgetconnectionclientid-forceget">MqttReqRes.getConnection(clientId, forceGet)</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.prototype.getConnection = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">clientId, forceGet</span>) </span>{

    <span class="hljs-keyword">var</span> connection = <span class="hljs-keyword">this</span>.connections.find(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">connection</span>) </span>{
      <span class="hljs-keyword">return</span> !!(connection &amp;&amp; connection.clientId === clientId);
    });

    <span class="hljs-keyword">if</span> (!connection &amp;&amp; forceGet &amp;&amp; clientId) {
      
      connection = {
        </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>connected client id e.g., &#39;WTwke7a4Yn5KobZbckgrRAj&#39;,</p></div></div><div class="code"><div class="wrapper">        clientId: clientId,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>sharedSecret string</p></div></div><div class="code"><div class="wrapper">        sharedSecret: <span class="hljs-literal">null</span>,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>connreq null|string the connection request id set and sent by the client that initiated the connection</p></div></div><div class="code"><div class="wrapper">        connreq: <span class="hljs-literal">null</span>,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>connack boolean|string the connection ack id </p></div></div><div class="code"><div class="wrapper">        connack: <span class="hljs-literal">null</span>,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>channel nonce: nonce for calculating channel ids </p></div></div><div class="code"><div class="wrapper">        channelNonce: <span class="hljs-literal">null</span>,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>publish -t message/&lt;this-client-id&gt;/&lt;channel-send-id&gt;/</p></div></div><div class="code"><div class="wrapper">        topicSend: <span class="hljs-literal">null</span>,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>subscribe -t message/&lt;connected-client-id&gt;/&lt;channel-receive-id&gt;/#</p></div></div><div class="code"><div class="wrapper">        topicReceive: <span class="hljs-literal">null</span>,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>&lt;channel-receive-id&gt;: the channel id of the channel this client listenes for messages sent by the other client. </p></div></div><div class="code"><div class="wrapper">        channelReceiveId: <span class="hljs-literal">null</span>,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>&lt;channel-send-id&gt;: the channel id of the channel this client sends messages to the other client. </p></div></div><div class="code"><div class="wrapper">        channelSendId: <span class="hljs-literal">null</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>channel-receive-id </p></div></div><div class="code"><div class="wrapper">      };

      <span class="hljs-keyword">this</span>.connections.push(connection);
    }

    <span class="hljs-keyword">return</span> connection;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqresgetconnected">MqttReqRes.getConnected()</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.prototype.getConnected = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.connections.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">connection</span>) </span>{
      <span class="hljs-keyword">return</span> MqttReqRes.isConnected(connection);
    });
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="streamsend-connection-messageid-msgtargetproperty-payload">streamSend (connection, messageId, msgTargetProperty, payload)</h3>
<p>send a string|object|ArrayBuffer payload within an existing message</p></div></div><div class="code"><div class="wrapper">  MqttReqRes.prototype.streamSend = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">connection, messageId, msgTargetProperty, payload</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>debug(
  &#39;%s streamSend(%s, %s, %s)&#39;, 
  this.clientId, connection.clientId, messageId, msgTargetProperty, payload
);</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
      type,
      payloadLength,
      streamId = MqttReqRes.randomString(STREAM_ID_LENGTH);
    
    <span class="hljs-keyword">if</span> (payload <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">ArrayBuffer</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ArrayBuffer</p></div></div><div class="code"><div class="wrapper">      type = <span class="hljs-string">'ArrayBuffer'</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (payload === <span class="hljs-literal">null</span>) {
      type = <span class="hljs-string">'null'</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (payload <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Object</span>) {
      type = <span class="hljs-string">'JSON'</span>;
    }
    <span class="hljs-keyword">else</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>string instanceof Object -&gt; false</p></div></div><div class="code"><div class="wrapper">      type = <span class="hljs-string">'string'</span>;
    }
    
    debug(<span class="hljs-string">'%s streamSend() type: %s'</span>, <span class="hljs-keyword">this</span>.clientId, type);    

    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'JSON'</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>payload as a JSON string</p></div></div><div class="code"><div class="wrapper">      payload = <span class="hljs-built_in">JSON</span>.stringify(payload);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'string'</span>){</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>payload as a string</p></div></div><div class="code"><div class="wrapper">      payload = <span class="hljs-built_in">String</span>(payload);      
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'null'</span>) {
      payload = <span class="hljs-string">'null'</span>;
    }

    payloadLength = (type === <span class="hljs-string">'ArrayBuffer'</span> ? 
      payload.byteLength : payload.length);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>_mqtt-message-stream: message-id, stream-id, message-target-property</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendStreamMessage</span> (<span class="hljs-params"></span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>debug(&#39;%s sendStreamMessage() to %s&#39;, self.clientId, connection.clientId);</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> self.mqttPublish(connection, <span class="hljs-string">'stream'</span>, <span class="hljs-built_in">JSON</span>.stringify({
          messageId: messageId,
          streamId: streamId,
          type: type,
          targetProperty: msgTargetProperty
        }))
        .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> self.waitForAck(<span class="hljs-string">'stream-ack'</span>, streamId);
        });
      }
      <span class="hljs-keyword">catch</span> (e) {
        debug(e);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(e);
      }
    }


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendChunks</span> (<span class="hljs-params"></span>) </span>{

      <span class="hljs-keyword">var</span> offset = <span class="hljs-number">0</span>,
        chunkno = <span class="hljs-number">0</span>,
        remainingLength = payloadLength,
        chunkSize,
        eos = <span class="hljs-literal">false</span>;

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{

        <span class="hljs-comment">/*jshint latedef:false*/</span>
        
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nextChunk</span> (<span class="hljs-params"></span>) </span>{

          <span class="hljs-keyword">var</span> chunkStr,
            chunkUint8Array;

          chunkSize = remainingLength &gt;= MAX_CHUNK_SIZE ?
            MAX_CHUNK_SIZE : remainingLength;

          eos = chunkSize === remainingLength;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>debug(&#39;%s sendChunks().nextChunk(): payloadLength %d remainingLength %d chunkno %d chunkSize %d eos %s&#39;,
  self.clientId, payloadLength,
  remainingLength,
  chunkno,
  chunkSize,
  eos
);</p></div></div><div class="code"><div class="wrapper">          <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'ArrayBuffer'</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>chunk as Uint8Array
new Uint8Array(buffer [, byteOffset [, length]]);</p></div></div><div class="code"><div class="wrapper">            chunkUint8Array = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(payload, offset, chunkSize);

            chunkStr = chunkUint8Array.join(<span class="hljs-string">','</span>);
          }
          <span class="hljs-keyword">else</span> {
            chunkStr = payload.substr(offset, chunkSize);
          }

          self.streamSendChunk(connection, streamId, chunkStr)
            .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            
              offset += chunkSize;

              remainingLength = payloadLength - offset;

              self.emit(<span class="hljs-string">'_chunk-sent'</span>, streamId);
            })
            .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">reason</span>) </span>{
              self.removeListener(<span class="hljs-string">'_chunk-sent'</span>, onChunkSent);
              reject(reason);
            });
        }


        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onChunkSent</span> (<span class="hljs-params">chunkSentStreamId</span>) </span>{
          
          <span class="hljs-keyword">if</span> (chunkSentStreamId !== streamId) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>not this stream</p></div></div><div class="code"><div class="wrapper">            <span class="hljs-keyword">return</span>;
          }

          <span class="hljs-keyword">if</span> (eos) {
            self.removeListener(<span class="hljs-string">'_chunk-sent'</span>, onChunkSent);
            resolve();
          }
          <span class="hljs-keyword">else</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>start next chunk request</p></div></div><div class="code"><div class="wrapper">            ++chunkno;
            nextChunk();
          }<span class="hljs-comment">// jshint ignore:line</span>
        } 


        self.on(<span class="hljs-string">'_chunk-sent'</span>, onChunkSent);

        nextChunk();
      });
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>_mqtt-message-stream-end: message-id, stream-id</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendStreamEndMessage</span> (<span class="hljs-params"></span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>debug(&#39;%s sendStreamEndMessage() to %s&#39;, self.clientId, connection.clientId);</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">return</span> self.mqttPublish(connection, <span class="hljs-string">'stream-end'</span>, <span class="hljs-built_in">JSON</span>.stringify({
        messageId: messageId,
        streamId: streamId
      }))
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> self.waitForAck(<span class="hljs-string">'stream-end-ack'</span>, streamId);
      });
    }


    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.connect(connection.clientId) 
      .then(sendStreamMessage)
      .then(sendChunks)
      .then(sendStreamEndMessage);
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="streamsendchunk-connection-streamid-messagechunkstr">streamSendChunk (connection, streamId, messageChunkStr)</h3>
<p>send a chunk message string
return Promise.resolve when connected, sent and acked</p></div></div><div class="code"><div class="wrapper">  MqttReqRes.prototype.streamSendChunk = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">connection, streamId, messageChunkStr</span>) </span>{

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
      req,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>generate a chunk id</p></div></div><div class="code"><div class="wrapper">      chunkId = MqttReqRes.randomString(CHUNK_ID_LENGTH);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>debug(&#39;%s streamSendChunk() to %s messageChunkStr &quot;%s&quot;, connection:&#39;, 
  this.clientId, connection.clientId,
  messageChunkStr,
  connection
);</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>-mqtt-message-chunk: stream-id chunk-id payload</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">publishChunk</span> (<span class="hljs-params"></span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>debug(&#39;%s publishChunk() to %s&#39;, self.clientId, connection.clientId);</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">try</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>build message object</p></div></div><div class="code"><div class="wrapper">        req = {
          streamId: streamId,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>chunk id</p></div></div><div class="code"><div class="wrapper">          chunkId: chunkId,
          payload: MqttReqRes.encrypt(messageChunkStr, connection.sharedSecret) 
        };

        <span class="hljs-keyword">return</span> self.mqttPublish(connection, <span class="hljs-string">'chunk'</span>, <span class="hljs-built_in">JSON</span>.stringify(req));
      }
      <span class="hljs-keyword">catch</span> (e) {
        debug(e);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(e);
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.connect(connection.clientId)
      .then(publishChunk)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> self.waitForAck(<span class="hljs-string">'chunk-ack'</span>, chunkId);
      });
  };


  MqttReqRes.prototype.sendAck = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">connection, ackMessageName, toId</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>debug(
  &#39;%s sendAck(%s, %s, toId %s)&#39;, this.clientId,
  connection.clientId, ackMessageName, toId
);</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> msgStr;

    <span class="hljs-keyword">try</span> {
      msgStr = <span class="hljs-built_in">JSON</span>.stringify({
        toId: toId
      });
    }
    <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(e);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.mqttPublish(connection, ackMessageName, msgStr);
  };  <span class="hljs-comment">// sendAck</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="waitforack-ackmessagename-toid-timeout5000">waitForAck (ackMessageName, toId, [timeout=5000])</h3>
<p>generic wait for ack message</p>
<ul>
<li>chunk-ack: to-id</li>
<li>stream-ack: to-id </li>
<li>stream-end-ack: to-id </li>
<li>request-ack: to-id</li>
<li>request-end-ack: to-id</li>
<li>response-ack: to-id</li>
<li>response-end-ack: to-id</li>
</ul></div></div><div class="code"><div class="wrapper">  MqttReqRes.prototype.waitForAck = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ackMessageName, toId, timeout</span>) </span>{

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
      ackEventName = <span class="hljs-string">'_mqtt-message-'</span> + ackMessageName;

    timeout = timeout || <span class="hljs-number">5000</span>;

    debug(
      <span class="hljs-string">'%s waitForAck(%s, %s, %d)'</span>, <span class="hljs-keyword">this</span>.clientId,
      ackMessageName, toId, timeout
    );

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{

        <span class="hljs-keyword">var</span> acked = <span class="hljs-literal">false</span>;

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleAck</span> (<span class="hljs-params">topicPath, ackMessage</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>debug(
  &#39;%s handleAck(%s), waits for: &quot;%s&quot; to id &quot;%s&quot;, ackMessage:&#39;, 
  self.clientId, ackMessage.toId, ackEventName, toId, ackMessage
);</p></div></div><div class="code"><div class="wrapper">          
          <span class="hljs-keyword">if</span> (ackMessage.toId === toId) {
            acked = <span class="hljs-literal">true</span>;
            self.removeListener(ackEventName, handleAck);
            resolve();
          }
        }

        self.on(ackEventName, handleAck);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>reject on timeout</p></div></div><div class="code"><div class="wrapper">        setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">if</span> (!acked) {
            self.removeListener(ackEventName, handleAck);
            reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'EACKTIMEOUT'</span>));
          }
        }, timeout);     
    });
  };  <span class="hljs-comment">// waitForAck</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="publish">publish</h3>
<p>generic mqtt publish</p></div></div><div class="code"><div class="wrapper">  MqttReqRes.prototype.mqttPublish = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">connection, subTopic, messageStr</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>debug(
  &#39;%s mqttPublish(%s, %s)&#39;, this.clientId,
  connection.clientId, subTopic
  // , messageStr
);</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{
      <span class="hljs-keyword">try</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>pubish message</p></div></div><div class="code"><div class="wrapper">        self.mqttClient.publish(        
          connection.topicSend + subTopic, 
          messageStr, 
          {qos: <span class="hljs-number">0</span>}, 
          <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
            <span class="hljs-keyword">if</span> (err) {
              debug(err);
              reject(err);
            }
            <span class="hljs-keyword">else</span> {
              resolve();
            }
          }
        );
      }
      <span class="hljs-keyword">catch</span> (e) {
        reject(e);
      }
    });
  };  <span class="hljs-comment">// mqttPublish</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="requeststring-toclientid-stringobjectarraybuffer-payload-object-meta">request(string toClientId, string|object|ArrayBuffer payload, object meta)</h3>
<p>A: request</p></div></div><div class="code"><div class="wrapper">  MqttReqRes.prototype.request = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">toClientId, payload, meta</span>) </span>{

    debug(<span class="hljs-string">'%s request(%s)'</span>, <span class="hljs-keyword">this</span>.clientId, toClientId);

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
      messageId = MqttReqRes.randomString(MESSAGE_ID_LENGTH),
      connection;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.connect(toClientId)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        connection = self.getConnection(toClientId);

        <span class="hljs-keyword">if</span> (!connection) {
          <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'ECLIENTCONNECTION'</span>));
        }

        <span class="hljs-keyword">return</span> self.mqttPublish(connection, <span class="hljs-string">'request'</span>, <span class="hljs-built_in">JSON</span>.stringify({
          messageId: messageId
        }));
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> self.waitForAck(<span class="hljs-string">'request-ack'</span>, messageId);
      })      
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> meta !== <span class="hljs-string">'object'</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>meta object is optional</p></div></div><div class="code"><div class="wrapper">          <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve();
        }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>meta streamSend (connection, messageId, msgTargetProperty, payload)</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">return</span> self.streamSend(connection, messageId, <span class="hljs-string">'meta'</span>, meta);
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>payload streamSend (connection, messageId, msgTargetProperty, payload)</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">return</span> self.streamSend(connection, messageId, <span class="hljs-string">'payload'</span>, payload);
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        self.mqttPublish(connection, <span class="hljs-string">'request-end'</span>, <span class="hljs-built_in">JSON</span>.stringify({
          messageId: messageId
        }));
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> self.waitForAck(<span class="hljs-string">'request-end-ack'</span>, messageId);
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> self.waitForResponse(connection, messageId);
      });
  };  <span class="hljs-comment">// request</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="waitforresponseconnection-tomessageid">waitForResponse(connection, toMessageId)</h3>
<p>A: response-ack</p></div></div><div class="code"><div class="wrapper">  MqttReqRes.prototype.waitForResponse = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">connection, toMessageId</span>) </span>{
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>debug(&#39;%s waitForResponse(toMessageId %s)&#39;, this.clientId, toMessageId);</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
      responseMessageId,
      response = {
        errors: []
      };


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitForMqttResponseMessage</span> (<span class="hljs-params"></span>) </span>{

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{

          <span class="hljs-keyword">var</span> received = <span class="hljs-literal">false</span>;

          <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleResponseMessage</span> (<span class="hljs-params">topicPath, responseMessage</span>) </span>{

            <span class="hljs-keyword">if</span> (responseMessage.respondsTo === toMessageId) {
            
              received = <span class="hljs-literal">true</span>;
              responseMessageId = responseMessage.messageId;

              self.removeListener(<span class="hljs-string">'_mqtt-message-response'</span>, handleResponseMessage);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A: response-ack</p></div></div><div class="code"><div class="wrapper">              self.sendAck(connection, <span class="hljs-string">'response-ack'</span>, responseMessageId)
                .then(resolve)
                .catch(reject);
            }
          }

          self.on(<span class="hljs-string">'_mqtt-message-response'</span>, handleResponseMessage);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>reject on timeout</p></div></div><div class="code"><div class="wrapper">          setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span> (!received) {
              self.removeListener(<span class="hljs-string">'_mqtt-message-response'</span>, handleResponseMessage);
              reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'ERESPONSETIMEOUT'</span>));
            }
          }, <span class="hljs-number">5000</span>);     
      });
    } <span class="hljs-comment">// waitForMqttResponseMessage</span>


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">receiveStream</span> (<span class="hljs-params">topicPath, mqttStreamMessage</span>) </span>{

      <span class="hljs-keyword">if</span> (mqttStreamMessage.messageId !== responseMessageId) {
        <span class="hljs-keyword">return</span>;
      }

      self.receiveStream(connection, mqttStreamMessage)
        .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">streamResult</span>) </span>{

          <span class="hljs-keyword">if</span> (mqttStreamMessage.targetProperty === <span class="hljs-string">'payload'</span>) {
            response.type = mqttStreamMessage.type;
          }

          response[mqttStreamMessage.targetProperty] = streamResult;
        })
        .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">reason</span>) </span>{
          response.errors.push(reason);
        });
    }


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitForResponseEnd</span> (<span class="hljs-params"></span>) </span>{

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{

          <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleResponseEndMessage</span> (<span class="hljs-params">topicPath, responseEndMessage</span>) </span>{

            <span class="hljs-keyword">if</span> (responseEndMessage.messageId === responseMessageId) {

              self.removeListener(<span class="hljs-string">'_mqtt-message-response-end'</span>, handleResponseEndMessage);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A: response-end-ack</p></div></div><div class="code"><div class="wrapper">              self.sendAck(connection, <span class="hljs-string">'response-end-ack'</span>, responseMessageId)
                .then(resolve)
                .catch(reject);
            }
          }

          self.on(<span class="hljs-string">'_mqtt-message-response-end'</span>, handleResponseEndMessage);
      });
    } <span class="hljs-comment">// waitForResponseEnd</span>


    <span class="hljs-keyword">return</span> waitForMqttResponseMessage()
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        self.on(<span class="hljs-string">'_mqtt-message-stream'</span>, receiveStream);
        <span class="hljs-keyword">return</span> waitForResponseEnd();
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        self.removeListener(<span class="hljs-string">'_mqtt-message-stream'</span>, receiveStream);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(response);
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">reason</span>) </span>{
        self.removeListener(<span class="hljs-string">'_mqtt-message-stream'</span>, receiveStream);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(reason);        
      });
  };  <span class="hljs-comment">// waitForResponse</span>


  MqttReqRes.prototype.receiveStream = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">connection, mqttStreamMessage</span>) </span>{
    
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
      streamId = mqttStreamMessage.streamId,
      type = mqttStreamMessage.type,
      streamResult = <span class="hljs-literal">null</span>,
      error;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">receiveChunk</span> (<span class="hljs-params">topicPath, mqttChunkMessage</span>) </span>{

      <span class="hljs-keyword">var</span> chunkData;
      <span class="hljs-keyword">try</span> {

        <span class="hljs-keyword">if</span> (mqttChunkMessage.streamId !== streamId) {
          <span class="hljs-keyword">return</span>;
        }

        chunkData = MqttReqRes.decrypt(mqttChunkMessage.payload, connection.sharedSecret);

        <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'ArrayBuffer'</span>) {
         
          <span class="hljs-keyword">if</span> (streamResult === <span class="hljs-literal">null</span>) {
            streamResult = [];
          }

          chunkData.split(<span class="hljs-string">','</span>).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">byteStr</span>) </span>{
            streamResult.push(byteStr);
          });
        } 
        <span class="hljs-keyword">else</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>assume type &#39;string&#39; or &#39;JSON&#39;</p></div></div><div class="code"><div class="wrapper">          <span class="hljs-keyword">if</span> (streamResult === <span class="hljs-literal">null</span>) {
            streamResult = <span class="hljs-string">''</span>;
          }
          streamResult += chunkData;
        }

        self.sendAck(connection, <span class="hljs-string">'chunk-ack'</span>, mqttChunkMessage.chunkId)
          .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">reason</span>) </span>{
            error = reason;
          });
      }
      <span class="hljs-keyword">catch</span> (e) {
        error = e;
      }
    }


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitForResponseStreamEnd</span> (<span class="hljs-params"></span>) </span>{

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{

          <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleResponseStreamEndMessage</span> (<span class="hljs-params">topicPath, streamEndMessage</span>) </span>{

            <span class="hljs-keyword">if</span> (streamEndMessage.streamId === streamId) {
          
              self.removeListener(<span class="hljs-string">'_mqtt-message-stream-end'</span>, handleResponseStreamEndMessage);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A: stream-end-ack</p></div></div><div class="code"><div class="wrapper">              self.sendAck(connection, <span class="hljs-string">'stream-end-ack'</span>, streamId)
                .then(resolve)
                .catch(reject);
            }
          }

          self.on(<span class="hljs-string">'_mqtt-message-stream-end'</span>, handleResponseStreamEndMessage);
      });
    } <span class="hljs-comment">// waitForResponseStreamEnd</span>


    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.sendAck(connection, <span class="hljs-string">'stream-ack'</span>, streamId)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        self.on(<span class="hljs-string">'_mqtt-message-chunk'</span>, receiveChunk);
        <span class="hljs-keyword">return</span> waitForResponseStreamEnd();
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        self.removeListener(<span class="hljs-string">'_mqtt-message-chunk'</span>, receiveChunk);
        
        <span class="hljs-keyword">if</span> (error) {
          <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(error);
        }
        
        <span class="hljs-keyword">try</span> {

          <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'ArrayBuffer'</span>) {
            streamResult = <span class="hljs-built_in">Uint8Array</span>.from(streamResult).buffer;
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'JSON'</span>) {
            streamResult = <span class="hljs-built_in">JSON</span>.parse(streamResult);
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'null'</span>) {
            streamResult = <span class="hljs-literal">null</span>;
          }
          
          <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(streamResult);
        }
        <span class="hljs-keyword">catch</span> (e) {
          <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(e);
        }
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">reason</span>) </span>{
        self.removeListener(<span class="hljs-string">'_mqtt-message-chunk'</span>, receiveChunk);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(reason);        
      });
  };  <span class="hljs-comment">// receiveStreams</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="onrequestfunction-onrequesthandler">onRequest(function onRequestHandler)</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.prototype.onRequest = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">onRequestCallback</span>) </span>{

    debug(<span class="hljs-string">'%s onRequest()'</span>, <span class="hljs-keyword">this</span>.clientId);

    <span class="hljs-keyword">this</span>.fnOnRequest = onRequestCallback; 
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqreshandlerequestmessagetopicpath-requestmessage">MqttReqRes.handleRequestMessage(topicPath, requestMessage)</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.prototype.handleRequestMessage = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">topicPath, requestMessage</span>) </span>{
    </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>debug(&#39;%s handleRequestMessage(%s)&#39;, this.clientId, topicPath.join(&#39;/&#39;));</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
      fromClientId,
      connection,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>secret,</p></div></div><div class="code"><div class="wrapper">      requestMessageId,
      request = {
        errors: []
      };


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">receiveStream</span> (<span class="hljs-params">topicPath, mqttStreamMessage</span>) </span>{

      <span class="hljs-keyword">if</span> (mqttStreamMessage.messageId !== requestMessageId) {
        <span class="hljs-keyword">return</span>;
      }

      self.receiveStream(connection, mqttStreamMessage)
        .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">streamResult</span>) </span>{

          <span class="hljs-keyword">if</span> (mqttStreamMessage.targetProperty === <span class="hljs-string">'payload'</span>) {
            request.type = mqttStreamMessage.type;
          }

          request[mqttStreamMessage.targetProperty] = streamResult;
        })
        .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">reason</span>) </span>{
          request.errors.push(reason);
        });
    }


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitForRequestEnd</span> (<span class="hljs-params"></span>) </span>{

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{

          <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleRequestEndMessage</span> (<span class="hljs-params">topicPath, requestEndMessage</span>) </span>{

            <span class="hljs-keyword">if</span> (requestEndMessage.messageId === requestMessageId) {

              self.removeListener(<span class="hljs-string">'_mqtt-message-request-end'</span>, handleRequestEndMessage);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>B: request-end-ack</p></div></div><div class="code"><div class="wrapper">              self.sendAck(connection, <span class="hljs-string">'request-end-ack'</span>, requestMessageId)
                .then(resolve)
                .catch(reject);
            }
          }

          self.on(<span class="hljs-string">'_mqtt-message-request-end'</span>, handleRequestEndMessage);
      });
    } <span class="hljs-comment">// waitForRequestEnd</span>


    <span class="hljs-keyword">try</span> {

      <span class="hljs-keyword">if</span> (<span class="hljs-string">'function'</span> !== <span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.fnOnRequest) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>no request handler defined, ignore message request</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
      }

      fromClientId = topicPath[<span class="hljs-number">1</span>];

      connection = <span class="hljs-keyword">this</span>.getConnection(fromClientId, <span class="hljs-literal">true</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>secret = this.getSharedSecret(connection);</p></div></div><div class="code"><div class="wrapper">      requestMessageId = requestMessage.messageId;

      <span class="hljs-keyword">this</span>.connect(fromClientId<span class="hljs-comment">/*, secret*/</span>)
        .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">return</span> self.sendAck(connection, <span class="hljs-string">'request-ack'</span>, requestMessageId);
        })
        .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

          self.on(<span class="hljs-string">'_mqtt-message-stream'</span>, receiveStream);

          <span class="hljs-keyword">return</span> waitForRequestEnd();
        })
        .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

          <span class="hljs-keyword">var</span> req, res;

          self.removeListener(<span class="hljs-string">'_mqtt-message-stream'</span>, receiveStream);

          req = {
            topic: topicPath.join(<span class="hljs-string">'/'</span>),
            payload: request.payload,
            type: request.type,
            meta: request.meta,
            errors: request.errors,
            connection: connection
          };

          res = {
            respondsTo: requestMessageId,
            send: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">payload, meta</span>) </span>{
              <span class="hljs-keyword">return</span> self.sendResponse(connection, requestMessageId, payload, meta);
            }
          };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>call request handler</p></div></div><div class="code"><div class="wrapper">          self.fnOnRequest(req, res);

        })
        .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">reason</span>) </span>{

          self.removeListener(<span class="hljs-string">'_mqtt-message-stream'</span>, receiveStream);
          debug(reason);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>return Promise.reject(reason);        </p></div></div><div class="code"><div class="wrapper">        });      
    }
    <span class="hljs-keyword">catch</span> (e) {
      debug(e);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="sendresponseobject-connection-string-respondtorequestid-stringobjectarraybuffer-payload-object-meta">sendResponse(object connection, string respondToRequestId, string|object|ArrayBuffer payload, object meta)</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.prototype.sendResponse = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">connection, respondToRequestId, payload, meta</span>) </span>{

    debug(<span class="hljs-string">'%s sendResponse(%s, %s)'</span>, <span class="hljs-keyword">this</span>.clientId, connection.clientId, respondToRequestId);

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
      messageId = MqttReqRes.randomString(MESSAGE_ID_LENGTH);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.connect(connection.clientId)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> self.mqttPublish(connection, <span class="hljs-string">'response'</span>, <span class="hljs-built_in">JSON</span>.stringify({
          messageId: messageId,
          respondsTo: respondToRequestId
        }));
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> self.waitForAck(<span class="hljs-string">'response-ack'</span>, messageId);
      })      
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> meta !== <span class="hljs-string">'object'</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>meta object is optional</p></div></div><div class="code"><div class="wrapper">          <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve();
        }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>meta streamSend (connection, messageId, msgTargetProperty, payload)</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">return</span> self.streamSend(connection, messageId, <span class="hljs-string">'meta'</span>, meta);
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>payload streamSend (connection, messageId, msgTargetProperty, payload)</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">return</span> self.streamSend(connection, messageId, <span class="hljs-string">'payload'</span>, payload);
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        self.mqttPublish(connection, <span class="hljs-string">'response-end'</span>, <span class="hljs-built_in">JSON</span>.stringify({
          messageId: messageId
        }));
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> self.waitForAck(<span class="hljs-string">'response-end-ack'</span>, messageId);
      });
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h4 id="connecttoclientid-sharedsecret">connect([toClientId, sharedSecret])</h4>
<ul>
<li>toClientId string optional default undefined. the id of the client to connect to     </li>
<li>sharedSecret string optional, required when toClientId is set   </li>
</ul></div></div><div class="code"><div class="wrapper">   
  MqttReqRes.prototype.connect = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">toClientId, sharedSecret</span>) </span>{

    debug(<span class="hljs-string">'%s connect(%s)'</span>, <span class="hljs-keyword">this</span>.clientId, toClientId);
    
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
      connection = <span class="hljs-keyword">this</span>.getConnection(toClientId);

    <span class="hljs-keyword">if</span> (MqttReqRes.isConnected(connection)) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve();
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>connect to broker</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.connectToBroker()
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">if</span> (toClientId) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>connect to other client when toClientId is set</p></div></div><div class="code"><div class="wrapper">          <span class="hljs-keyword">return</span> self.connectToClient(toClientId, sharedSecret);
        }
        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(connection);
        }
      });
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h4 id="connecttobroker">connectToBroker()</h4>
<p>  connect to broker</p></div></div><div class="code"><div class="wrapper">  MqttReqRes.prototype.connectToBroker = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    debug(<span class="hljs-string">'%s connectToBroker()'</span>, <span class="hljs-keyword">this</span>.clientId);

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{

      <span class="hljs-keyword">var</span> connectSuccess = <span class="hljs-literal">false</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>already connected to broker?</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (self.mqttClient &amp;&amp; self.mqttClient.connected) {
        resolve();
        <span class="hljs-keyword">return</span>;
      }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>reset subsciption to connect flag</p></div></div><div class="code"><div class="wrapper">      self.subscribedConnect = <span class="hljs-literal">false</span>;
      self.isWaitingForMqttClientMessages = <span class="hljs-literal">false</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>connect to broker</p></div></div><div class="code"><div class="wrapper">      self.mqttClient = mqtt.connect({ 
          protocol: self.brokerProtocol,
          host: self.brokerHostname, 
          port: self.brokerPort,
          clientId: self.clientId
        });

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onConnect</span> (<span class="hljs-params"></span>) </span>{
        self.emit(
          <span class="hljs-string">'_broker-connect'</span>, </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>connack packet</p></div></div><div class="code"><div class="wrapper">          <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>)[<span class="hljs-number">0</span>]
        );
      }
      
      self.mqttClient.on(<span class="hljs-string">'connect'</span>, onConnect); 

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onBrokerConnect</span> (<span class="hljs-params"></span>) </span>{
        connectSuccess = <span class="hljs-literal">true</span>;
        self.removeListener(<span class="hljs-string">'connect'</span>, onConnect);
        self.removeListener(<span class="hljs-string">'_broker-connect'</span>, onBrokerConnect);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>subscribe to connect topic</p></div></div><div class="code"><div class="wrapper">        self.subscribeConnect()
          .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
             self.emit(<span class="hljs-string">'broker.connect'</span>);
             resolve();
          })
          .catch(reject);
      }

      self.once(<span class="hljs-string">'_broker-connect'</span>, onBrokerConnect);

      setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (!connectSuccess) {
          self.removeListener(<span class="hljs-string">'connect'</span>, onConnect);
          self.removeListener(<span class="hljs-string">'_broker-connect'</span>, onBrokerConnect);          
          reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'EMQTTCLIENTCONNECTTIMEOUT'</span>));
        }
      }, <span class="hljs-number">3000</span>);
    });
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h4 id="subscribeconnect">subscribeConnect()</h4>
<p>  subscribe to topic connect/&lt;client-id&gt;/#</p></div></div><div class="code"><div class="wrapper">  MqttReqRes.prototype.subscribeConnect = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    debug(<span class="hljs-string">'%s subscribeConnect()'</span>, <span class="hljs-keyword">this</span>.clientId);

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
      topic = <span class="hljs-string">'connect/'</span> + <span class="hljs-keyword">this</span>.clientId + <span class="hljs-string">'/+'</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>check for broker connection</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (!self.mqttClient || !self.mqttClient.connected) {
        reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'EMQTTCLIENTCONNECTION'</span>));
        <span class="hljs-keyword">return</span>;
      }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>check if already subscribed to topic connect </p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (self.subscribedConnect) {
        resolve();
        <span class="hljs-keyword">return</span>;
      }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>subscribe to connect topic</p></div></div><div class="code"><div class="wrapper">      self.mqttClient.subscribe(
        topic, 
        {qos: <span class="hljs-number">0</span>}, 
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, granted</span>) </span>{
          <span class="hljs-keyword">if</span> (err) {
            reject(err);
          }
          <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (granted[<span class="hljs-number">0</span>].qos === <span class="hljs-number">0</span>) {
              self.subscribedConnect = <span class="hljs-literal">true</span>;
              <span class="hljs-keyword">try</span> {
                self.waitForMqttClientMessages();
                resolve();                           
              }
              <span class="hljs-keyword">catch</span> (e) {
                reject(e);
              }
            }
            <span class="hljs-keyword">else</span> {
              reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'ESUBSCRIBECONNECT'</span>));
            }
          }
        }
      );
    });
  };
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="connecttoclient-toclientid-sharedsecret">connectToClient (toClientId[, sharedSecret])</h3>
<ul>
<li>toClientId string required. the id of the client to connect to</li>
<li>sharedSecret string optional. if set, sharedSecret will be set to connection    </li>
</ul></div></div><div class="code"><div class="wrapper">  MqttReqRes.prototype.connectToClient = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">toClientId, sharedSecret</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A connect(B)</p></div></div><div class="code"><div class="wrapper">    debug(<span class="hljs-string">'%s connectToClient(%s)'</span>, <span class="hljs-keyword">this</span>.clientId, toClientId);

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
      connection = <span class="hljs-keyword">this</span>.getConnection(toClientId, <span class="hljs-literal">true</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>when connreq &amp;&amp; connack === connreq</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (MqttReqRes.isConnected(connection)) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve();
    }

    <span class="hljs-keyword">if</span> (sharedSecret) {
      connection.sharedSecret = sharedSecret;
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>else when !connreq || connack !== connreq</li>
</ul></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>set connreq = randomString</li>
</ul></div></div><div class="code"><div class="wrapper">    connection.connreq = MqttReqRes.randomString(CHANNEL_ID_LENGTH);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>set connack = null</li>
</ul></div></div><div class="code"><div class="wrapper">    connection.connack = <span class="hljs-literal">null</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>set channelNonce = randomString()</li>
</ul></div></div><div class="code"><div class="wrapper">    connection.channelNonce = MqttReqRes.randomString(CHANNEL_NONCE_LENGTH);

    connection.channelReceiveId = <span class="hljs-literal">null</span>;
    connection.topicReceive = <span class="hljs-literal">null</span>;
    connection.channelSendId = <span class="hljs-literal">null</span>;
    connection.topicSend = <span class="hljs-literal">null</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">awaitConnack</span> (<span class="hljs-params"></span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>wait for connackResolve</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{


        <span class="hljs-keyword">var</span> resolved = <span class="hljs-literal">false</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>handleConnectAck (ev{connack,channelNonce})</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleClientConnack</span> (<span class="hljs-params">ev</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>  when connreq &amp;&amp; connreq === connackB</p></div></div><div class="code"><div class="wrapper">          <span class="hljs-keyword">if</span> (
              ev &amp;&amp;
              ev.clientId === toClientId &amp;&amp; 
              ev.connack === connection.connreq &amp;&amp;
              ev.channelNonce
            ) {           

            self.removeListener(<span class="hljs-string">'_client-connack'</span>, handleClientConnack);

            debug(<span class="hljs-string">'%s client connect in connectToClient()'</span>, self.clientId, toClientId);   </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><pre><code>- set connack = connreq</code></pre></div></div><div class="code"><div class="wrapper">            connection.connack = connection.connreq;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><pre><code>- set channelSendId = hash(connack, channelNonce, channelNonceB, sharedSecretAB)</code></pre></div></div><div class="code"><div class="wrapper">            connection.channelSendId = MqttReqRes.hash(
                connection.connack,
                connection.channelNonce,
                ev.channelNonce,
                connection.sharedSecret
              );</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>set channelReceiveId = hash(connack, channelNonceB, channelNonce, sharedSecretAB)</li>
</ul></div></div><div class="code"><div class="wrapper">            connection.channelReceiveId = MqttReqRes.hash(
                connection.connack,
                ev.channelNonce,
                connection.channelNonce,
                connection.sharedSecret
              );

            connection.topicReceive = <span class="hljs-literal">null</span>;
            connection.topicSend = <span class="hljs-literal">null</span>;

            resolved = <span class="hljs-literal">true</span>;

            resolve(toClientId);
          }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>else<ul>
<li>ignore</li>
</ul>
</li>
</ul></div></div><div class="code"><div class="wrapper">        }

        self.on(<span class="hljs-string">'_client-connack'</span>, handleClientConnack);
        </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>reject on timeout</p></div></div><div class="code"><div class="wrapper">        setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">if</span> (!resolved) {
            self.removeListener(<span class="hljs-string">'_client-connack'</span>, handleClientConnack);
            reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'ECLIENTCONNACKTIMEOUT'</span>));
          }
        }, <span class="hljs-number">10000</span>);
      });
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A  - send connreq,channelNonce to B.handleConnectRequest()</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.publishConnectRequest(toClientId)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> self.getSharedSecret(connection);
      })</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>wait for connackResolve</li>
</ul></div></div><div class="code"><div class="wrapper">      .then(awaitConnack)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><pre><code>- subscribe topic to receive from B</code></pre></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">return</span> self.subscribeReceiveChannel(toClientId);
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{    
        <span class="hljs-keyword">if</span> (MqttReqRes.isConnected(connection)) {
          self.emit(<span class="hljs-string">'client.connect'</span>, toClientId);
          <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(toClientId);
        }
        <span class="hljs-keyword">else</span> {
          debug(<span class="hljs-string">'failed to connect to client'</span>, connection);
          <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'ECLIENTCONNECT'</span>));
        }
      });
  };


  MqttReqRes.prototype.ping = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">toClientId</span>) </span>{

    debug(<span class="hljs-string">'%s ping(%s)'</span>, <span class="hljs-keyword">this</span>.clientId, toClientId);

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
      messageId = MqttReqRes.randomString(MESSAGE_ID_LENGTH),
      connection;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.connect(toClientId)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        connection = self.getConnection(toClientId);

        <span class="hljs-keyword">if</span> (!connection) {
          <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'ECLIENTCONNECTION'</span>));
        }

        <span class="hljs-keyword">return</span> self.mqttPublish(connection, <span class="hljs-string">'ping'</span>, <span class="hljs-built_in">JSON</span>.stringify({
          messageId: messageId
        }));
      })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> self.waitForAck(<span class="hljs-string">'ping-ack'</span>, messageId);
      });
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h4 id="waitformqttclientmessages">waitForMqttClientMessages()</h4></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.prototype.waitForMqttClientMessages = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    debug(<span class="hljs-string">'%s waitForMqttClientMessages()'</span>, <span class="hljs-keyword">this</span>.clientId);

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isWaitingForMqttClientMessages) {
      <span class="hljs-keyword">return</span>;
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>check for broker connection</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.mqttClient || !<span class="hljs-keyword">this</span>.mqttClient.connected) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'EMQTTCLIENTCONNECTION'</span>);
    }

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.subscribedConnect) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'ESUBSCRIBEDCONNECT'</span>);
    }

    <span class="hljs-keyword">this</span>.isWaitingForMqttClientMessages = <span class="hljs-literal">true</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>handle incoming messages</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">this</span>.mqttClient.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">topic, message</span>) </span>{
      <span class="hljs-keyword">try</span> {
        self.handleMqttClientMessage(topic, message);
      }
      <span class="hljs-keyword">catch</span>(e) {
        debug(e);
      }
    });

    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'_mqtt-message-request'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      self.handleRequestMessage.apply(self, <span class="hljs-built_in">arguments</span>);
    });


    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'_mqtt-message-ping'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      self.handlePingRequest.apply(self, <span class="hljs-built_in">arguments</span>);
    });

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="handlepingrequest">handlePingRequest</h3>
<p>  B: ping-ack</p></div></div><div class="code"><div class="wrapper">  MqttReqRes.prototype.handlePingRequest = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">topicPath, message</span>) </span>{

    debug(<span class="hljs-string">'%s handlePingRequest'</span>, <span class="hljs-keyword">this</span>.clientId, message.messageId);
    
    <span class="hljs-keyword">try</span> {

      <span class="hljs-keyword">var</span> fromClientId = topicPath[<span class="hljs-number">1</span>],
        connection = <span class="hljs-keyword">this</span>.getConnection(fromClientId);

      <span class="hljs-keyword">if</span> (connection &amp;&amp; MqttReqRes.isConnected(connection)) {

        <span class="hljs-keyword">this</span>.sendAck(connection, <span class="hljs-string">'ping-ack'</span>, message.messageId)
          .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">reason</span>) </span>{
            debug(reason);
          });            
      }
    } 
    <span class="hljs-keyword">catch</span>(e) {
      debug(e);
    }     

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqreshandlemqttclientmessagetopic-mqttmessage">MqttReqRes.handleMqttClientMessage(topic, mqttMessage)</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.prototype.handleMqttClientMessage = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">topic, mqttMessage</span>) </span>{

    debug(<span class="hljs-string">'%s handleMqttClientMessage(%s)'</span>, <span class="hljs-keyword">this</span>.clientId, topic);

    <span class="hljs-keyword">var</span> topicPath = topic.split(<span class="hljs-string">'/'</span>),
      message,
      messageTypeIndex;

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isWaitingForMqttClientMessages) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">if</span> (!mqttMessage) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">try</span> {
      
      message = <span class="hljs-built_in">JSON</span>.parse(mqttMessage);

      <span class="hljs-keyword">if</span> (!message || <span class="hljs-string">'object'</span> !== <span class="hljs-keyword">typeof</span> message) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ignore message</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">if</span> (topicPath[<span class="hljs-number">0</span>] === <span class="hljs-string">'connect'</span>) {
          </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>is connect topic publish -t connect/to-device-id/from-device-id -m connack|connreq</p></div></div><div class="code"><div class="wrapper">        
        <span class="hljs-keyword">if</span> (message.connreq) {
          <span class="hljs-keyword">this</span>.handleConnectRequest(topicPath, message);
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (message.connack) {
          <span class="hljs-keyword">this</span>.handleConnectAck(topicPath, message);
        }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>else: ignore</p></div></div><div class="code"><div class="wrapper">      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (topicPath[<span class="hljs-number">0</span>] === <span class="hljs-string">'message'</span>){</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>is message topic publish -t message/<from-device-id>/<to-channel-id>/<mqtt-message-type></p></div></div><div class="code"><div class="wrapper">        messageTypeIndex = messageTypes.indexOf(topicPath[<span class="hljs-number">3</span>]);

        <span class="hljs-keyword">if</span> (messageTypeIndex !== -<span class="hljs-number">1</span>) {
          <span class="hljs-keyword">this</span>.emit(
            <span class="hljs-string">'_mqtt-message-'</span> + messageTypes[messageTypeIndex], 
            topicPath, 
            message
          );
          debug(
            <span class="hljs-string">'%s emitted %s , %s'</span>, <span class="hljs-keyword">this</span>.clientId, 
            topicPath.join(<span class="hljs-string">'/'</span>), 
            <span class="hljs-string">'_mqtt-message-'</span> + messageTypes[messageTypeIndex]</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>message</p></div></div><div class="code"><div class="wrapper">          );
        }
        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">throw</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'EMESSAGETYPE'</span>));
        }
      }

    }
    <span class="hljs-keyword">catch</span> (e) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ignore errors</p></div></div><div class="code"><div class="wrapper">      debug(e);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h4 id="handleconnectrequest">handleConnectRequest</h4>
<p>  -t connect/to-device-id/from-device-id -m channel-receive-id</p></div></div><div class="code"><div class="wrapper">  MqttReqRes.prototype.handleConnectRequest = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">topicPath, reqMessage</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>B handleConnectRequest (reqMessage{connreqA, channelNonceA})</p></div></div><div class="code"><div class="wrapper">    debug(<span class="hljs-string">'%s handleConnectRequest(%s)'</span>, <span class="hljs-keyword">this</span>.clientId, topicPath.join(<span class="hljs-string">'/'</span>));

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
      clientId,
      connection;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>validate topic</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>check if connecting to this client</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (topicPath[<span class="hljs-number">1</span>] !== <span class="hljs-keyword">this</span>.clientId) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>not to this client</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">return</span>;
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>when !connreq</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (!reqMessage.connreq) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><pre><code>- ignore, done</code></pre></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">if</span> (!reqMessage.channelNonce) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>no channel id for sending channel is set</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">return</span>;
    }

    clientId = topicPath[<span class="hljs-number">2</span>];

    <span class="hljs-keyword">if</span> (!clientId) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>invalid connect request</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">return</span>;
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>get connection </p></div></div><div class="code"><div class="wrapper">    connection = <span class="hljs-keyword">this</span>.getConnection(clientId, <span class="hljs-literal">true</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>else when !connreq || connreqA !== connack</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (!connection.connreq || reqMessage.connreq !== connection.connack) {

      self.getSharedSecret(connection)
        .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>set connreq = connreqA</li>
</ul></div></div><div class="code"><div class="wrapper">          connection.connreq = reqMessage.connreq;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>set connack = connreqA</li>
</ul></div></div><div class="code"><div class="wrapper">          connection.connack = reqMessage.connreq;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>set channelNonce = randomString()</li>
</ul></div></div><div class="code"><div class="wrapper">          connection.channelNonce = MqttReqRes.randomString(CHANNEL_NONCE_LENGTH);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>set channelSendId = hash(connack, channelNonce, channelNonceA, sharedSecretAB)</li>
</ul></div></div><div class="code"><div class="wrapper">          connection.channelSendId = MqttReqRes.hash(
              connection.connack,
              connection.channelNonce,
              reqMessage.channelNonce,
              connection.sharedSecret
            );</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>set channelReceiveId = hash(connack, channelNonceA, channelNonce, sharedSecretAB)</li>
</ul></div></div><div class="code"><div class="wrapper">          connection.channelReceiveId = MqttReqRes.hash(
              connection.connack,
              reqMessage.channelNonce,
              connection.channelNonce,
              connection.sharedSecret
            );

          connection.topicReceive = <span class="hljs-literal">null</span>;
          connection.topicSend = <span class="hljs-literal">null</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>subscribe topic to receive from A</li>
</ul></div></div><div class="code"><div class="wrapper">          <span class="hljs-keyword">return</span> self.subscribeReceiveChannel(clientId);
        })
        .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>send connack,channelNonce to A.handleConnectAck()</li>
</ul></div></div><div class="code"><div class="wrapper">          <span class="hljs-keyword">return</span> self.publishConnectAck(clientId);
        })
        .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">if</span> (MqttReqRes.isConnected(connection)) {
            self.emit(<span class="hljs-string">'client.connect'</span>, clientId);
          }
          <span class="hljs-keyword">else</span> {
            debug(<span class="hljs-string">'failed to connect to client'</span>, connection);
          }
        })
        .catch(noop);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>done</li>
</ul></div></div><div class="code"><div class="wrapper">    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>else when connreqA === connack</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (connection.connack === reqMessage.connreq) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>connection already established</p>
<ul>
<li>send connack,channelNonce to A.handleConnectAck()</li>
</ul></div></div><div class="code"><div class="wrapper">      self.publishConnectAck(clientId);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>done</li>
</ul></div></div><div class="code"><div class="wrapper">    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>else  ignore, done</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqressharedsecretfngetsharedsecret">MqttReqRes.sharedSecret(fnGetSharedSecret)</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.prototype.sharedSecret = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fnGetSharedSecret</span>) </span>{

    <span class="hljs-keyword">this</span>.fnGetSharedSecret = <span class="hljs-string">'function'</span> === <span class="hljs-keyword">typeof</span> fnGetSharedSecret ?
      fnGetSharedSecret : <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqresgetsharedsecretconnection">MqttReqRes.getSharedSecret(connection)</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.prototype.getSharedSecret = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">connection</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>debug(&#39;%s getSharedSecret(%s)&#39;, this.clientId, connection &amp;&amp; connection.clientId);</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{
      <span class="hljs-keyword">if</span> (!connection) {
        reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'ECLIENTCONNECTION'</span>));
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (connection.sharedSecret) {
        resolve(connection.sharedSecret);
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'function'</span> === <span class="hljs-keyword">typeof</span> self.fnGetSharedSecret) {
        self.fnGetSharedSecret(connection.clientId, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">sharedSecret</span>) </span>{
          <span class="hljs-keyword">if</span> (!sharedSecret) {
            reject();
          }
          <span class="hljs-keyword">else</span> {
            connection.sharedSecret = sharedSecret;
            resolve(sharedSecret);
          }
        });
      }
      <span class="hljs-keyword">else</span> {
        resolve();
      }
    });
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqrespublishconnectackclientid">MqttReqRes.publishConnectAck(clientId)</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.prototype.publishConnectAck = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">clientId</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>debug(&#39;%s publishConnectAck(%s)&#39;, this.clientId, clientId);</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{
      </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>get connection </p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">var</span> connection = self.getConnection(clientId),
        topic,
        message;

      topic = <span class="hljs-string">'connect/'</span> + clientId + <span class="hljs-string">'/'</span> + self.clientId;

      message = <span class="hljs-built_in">JSON</span>.stringify({
        connack: connection.connack,
        channelNonce: connection.channelNonce
      });

      self.mqttClient.publish(
        topic,
        message, 
        {qos: <span class="hljs-number">0</span>, retain: <span class="hljs-literal">false</span>}, 
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
          <span class="hljs-keyword">if</span> (err) {
            reject(err);
          }
          <span class="hljs-keyword">else</span> {
            resolve(clientId);            
          }
        }
      );
    });      
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqreshandleconnectacktopicpath-ackmessage">MqttReqRes.handleConnectAck(topicPath, ackMessage)</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.prototype.handleConnectAck = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">topicPath, ackMessage</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A handleConnectAck (ackMessage{connackB, channelNonceB})</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>debug(&#39;%s handleConnectAck(%s)&#39;, this.clientId, topicPath.join(&#39;/&#39;));</p></div></div><div class="code"><div class="wrapper">    
    <span class="hljs-keyword">var</span> clientId;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>validate topic</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>check if connecting to this client</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (topicPath[<span class="hljs-number">1</span>] !== <span class="hljs-keyword">this</span>.clientId) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>not to this client</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">return</span>;
    }

    clientId = topicPath[<span class="hljs-number">2</span>];

    <span class="hljs-keyword">if</span> (!clientId) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>invalid connect request</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'_client-connack'</span>, {
      clientId: clientId,
      connack: ackMessage.connack,
      channelNonce: ackMessage.channelNonce,
    });

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h4 id="subscribereceivechannelclientid">subscribeReceiveChannel(clientId)</h4>
<p>  opens a message channel to enable other client to send messages</p></div></div><div class="code"><div class="wrapper">  MqttReqRes.prototype.subscribeReceiveChannel = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">clientId</span>) </span>{

    debug(<span class="hljs-string">'%s subscribeReceiveChannel(%s)'</span>, <span class="hljs-keyword">this</span>.clientId, clientId);

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>get connected client </p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">var</span> connection = self.getConnection(clientId),
        topic;

      <span class="hljs-keyword">if</span> (!connection) {
        reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'ECLIENTCONNECTION'</span>));
        <span class="hljs-keyword">return</span>;
      }
      </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>build topic</p>
<p>subscribe -t message/<from-device-id>/<to-channel-id>/#</p></div></div><div class="code"><div class="wrapper">      topic = <span class="hljs-string">'message/'</span> + clientId + <span class="hljs-string">'/'</span> + connection.channelReceiveId + <span class="hljs-string">'/#'</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>subscribe to connect topic -t message/&lt;from-device-id&gt;/&lt;to-channel-id&gt;/#</p></div></div><div class="code"><div class="wrapper">      self.mqttClient.subscribe(
        topic, 
        {qos: <span class="hljs-number">0</span>}, 
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, granted</span>) </span>{
          <span class="hljs-keyword">if</span> (err) {
            reject(err);
            <span class="hljs-keyword">return</span>;
          }

          <span class="hljs-keyword">if</span> (granted[<span class="hljs-number">0</span>].qos === <span class="hljs-number">0</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>set topicReceive: subscribe -t &#39;message/&lt;connected-client-id&gt;/&lt;channel-receive-id&gt;/#&#39;</p></div></div><div class="code"><div class="wrapper">            connection.topicReceive = topic;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>set topicSend: publish -t &#39;message/&lt;this-client-id&gt;/&lt;channel-send-id&gt;/&#39;</p></div></div><div class="code"><div class="wrapper">            connection.topicSend = <span class="hljs-string">'message/'</span> + self.clientId + <span class="hljs-string">'/'</span> + connection.channelSendId + <span class="hljs-string">'/'</span>;

            resolve(clientId);           
          }
          <span class="hljs-keyword">else</span> {
            reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'ESUBSCRIBERECEIVE'</span>));
          }
        }
      );
    });
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h4 id="publishconnectrequest">publishConnectRequest()</h4>
<p>  publish a connect message to the other client to let him know this client wants to connect</p>
<p>  publish -t connect/to-device-id/from-device-id -m</p></div></div><div class="code"><div class="wrapper">  MqttReqRes.prototype.publishConnectRequest = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">clientId</span>) </span>{

    debug(<span class="hljs-string">'%s publishConnectRequest(%s)'</span>, <span class="hljs-keyword">this</span>.clientId, clientId);

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{
      </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>get connected client </p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">var</span> connection = self.getConnection(clientId, <span class="hljs-literal">true</span>),
        topic,
        message;

      topic = <span class="hljs-string">'connect/'</span> + clientId + <span class="hljs-string">'/'</span> + self.clientId;

      message = <span class="hljs-built_in">JSON</span>.stringify({
        connreq: connection.connreq,
        channelNonce: connection.channelNonce
      });

      self.mqttClient.publish(
        topic,
        message, 
        {qos: <span class="hljs-number">0</span>, retain: <span class="hljs-literal">false</span>}, 
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
          <span class="hljs-keyword">if</span> (err) {
            reject(err);
          }
          <span class="hljs-keyword">else</span> {
            resolve(clientId);            
          }
        }
      );
    });
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h4 id="disconnect-a-client-or-from-broker-if-clientid-is-omitted">disconnect a client or from broker if clientId is omitted</h4></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.prototype.disconnect = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">clientId</span>) </span>{

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{

      <span class="hljs-keyword">var</span> connection;

      <span class="hljs-keyword">if</span> (!clientId) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>disconnect from broker</p></div></div><div class="code"><div class="wrapper">        self.disconnectBroker()
          .then(resolve)
          .catch(reject);
      }
      <span class="hljs-keyword">else</span> {

        connection = self.getConnection(clientId);

        <span class="hljs-keyword">if</span> (!connection || !MqttReqRes.isConnected(connection)) {
          resolve();
          <span class="hljs-keyword">return</span>;
        }
        
        self.disconnectClient(connection)
          .then(resolve)
          .catch(reject);
      }
    });
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqresdisconnectclientconnection">MqttReqRes.disconnectClient(connection)</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.prototype.disconnectClient = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">connection</span>) </span>{

    debug(<span class="hljs-string">'%s disconnectClient(%s)'</span>, <span class="hljs-keyword">this</span>.clientId, connection &amp;&amp; connection.clientId);

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
      index;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve</span>) </span>{

      <span class="hljs-keyword">if</span> (!connection) {
        resolve();
        <span class="hljs-keyword">return</span>;
      }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>remove from clients list</p></div></div><div class="code"><div class="wrapper">      index = self.connections.indexOf(connection);

      <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) {
        self.connections.splice(index, <span class="hljs-number">1</span>);
      }

      <span class="hljs-keyword">if</span> (connection.topicReceive) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>unsubscribe receive topic</p></div></div><div class="code"><div class="wrapper">        self.mqttClient.unsubscribe(
          connection.topicReceive, 
          <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            connection.topicReceive = <span class="hljs-literal">null</span>;
            resolve();
          }
        );
      }
      <span class="hljs-keyword">else</span> {
        resolve();
      }

    });
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqresdisconnectbroker">MqttReqRes.disconnectBroker()</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.prototype.disconnectBroker = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    debug(<span class="hljs-string">'%s disconnectBroker()'</span>, <span class="hljs-keyword">this</span>.clientId);

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve</span>) </span>{

      <span class="hljs-keyword">if</span> (self.mqttClient) {
        self.mqttClient.end(<span class="hljs-literal">true</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
          self.initialize(self.options);
          resolve();
        });
      }
      <span class="hljs-keyword">else</span> {
        self.initialize(self.options);
        resolve();
      }
      
    });
  };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="mqttreqresclosecallback">MqttReqRes.close(callback)</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  MqttReqRes.prototype.close = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) </span>{

    debug(<span class="hljs-string">'%s close()'</span>, <span class="hljs-keyword">this</span>.clientId);

    callback = callback || noop;

    <span class="hljs-keyword">this</span>.disconnect()
      .then(callback)
      .catch(callback);
  };


  <span class="hljs-keyword">return</span> MqttReqRes;

}();</div></div></div></div></body></html>